<app-menu></app-menu>

<!-- Toast notifications -->
<p-toast></p-toast>

<div class="container">
  <h2>GÃ©nÃ©ration de Facture Professionnelle</h2>

  <!-- Spinner de chargement global -->
  <div *ngIf="isLoading" class="loading-overlay">
    <p-progressSpinner></p-progressSpinner>
    <p>Traitement en cours...</p>
  </div>

  <!-- Formulaire de crÃ©ation de facture -->
  <div *ngIf="!factureGeneree">

    <!-- Loading state initial -->
    <div *ngIf="isInitializing" class="loading-overlay">
      <p-progressSpinner></p-progressSpinner>
      <p>Chargement des programmes...</p>
    </div>

    <form [formGroup]="factureForm" (ngSubmit)="generateInvoice()" novalidate>

      <!-- ===== SÃ‰LECTION DU PROGRAMME ===== -->
      <div class="form-section">
        <h3>ğŸ“‹ SÃ©lection du Programme</h3>

        <div class="field">
          <label for="programme">Programme GP *</label>
          <p-dropdown
            id="programme"
            formControlName="programme"
            [options]="programmes"
            optionLabel="description"
            optionValue="id"
            placeholder="SÃ©lectionnez un programme"
            [showClear]="true"
            [filter]="true"
            filterBy="description,depart,destination"
            [style]="{'width': '100%'}"
            [disabled]="isFormDisabled"
            emptyMessage="Aucun programme disponible"
            emptyFilterMessage="Aucun programme trouvÃ©"
          >
            <ng-template pTemplate="selectedItem" let-selectedProgramme>
              <div *ngIf="selectedProgramme" class="flex align-items-center">
                <span>{{ selectedProgramme.description }}</span>
                <p-tag
                  [value]="selectedProgramme.depart + ' â†’ ' + selectedProgramme.destination"
                  severity="info"
                  class="ml-2">
                </p-tag>
              </div>
            </ng-template>

            <ng-template pTemplate="item" let-programme>
              <div class="flex align-items-center justify-content-between w-full">
                <div>
                  <div class="font-bold">{{ programme.description }}</div>
                  <div class="text-sm text-color-secondary">
                    {{ programme.depart }} â†’ {{ programme.destination }}
                  </div>
                </div>
                <div class="text-right">
                  <div class="font-bold text-primary">{{ programme.prix }}</div>
                  <div class="text-xs text-color-secondary">{{ programme.garantie }}% garantie</div>
                </div>
              </div>
            </ng-template>
          </p-dropdown>

          <small *ngIf="programmeError" class="text-danger">
            <i class="pi pi-exclamation-triangle"></i>
            {{ programmeError }}
          </small>

          <small *ngIf="programmes.length === 0 && !isInitializing" class="text-danger">
            <i class="pi pi-info-circle"></i>
            Aucun programme disponible. Veuillez d'abord crÃ©er un programme GP.
          </small>
        </div>
      </div>

      <!-- ===== DÃ‰TAILS DU PROGRAMME SÃ‰LECTIONNÃ‰ ===== -->
      <div *ngIf="selectedProgramme" class="programme-details">
        <h3>ğŸ“‹ DÃ©tails du Programme SÃ©lectionnÃ©</h3>

        <div class="detail-grid">
          <div class="detail-row">
            <div class="detail-item">
              <span class="label">ğŸš© DÃ©part :</span>
              <span class="value">{{ selectedProgramme.depart }}</span>
            </div>
            <div class="detail-item">
              <span class="label">ğŸ¯ Destination :</span>
              <span class="value">{{ selectedProgramme.destination }}</span>
            </div>
          </div>

          <div class="detail-row">
            <div class="detail-item">
              <span class="label">ğŸ’° Prix par KG :</span>
              <span class="value">{{ selectedProgramme.prix }}</span>
            </div>
            <div class="detail-item">
              <span class="label">ğŸ›¡ï¸ Garantie :</span>
              <span class="value">{{ selectedProgramme.garantie }}%</span>
            </div>
          </div>

          <div class="detail-row">
            <div class="detail-item">
              <span class="label">ğŸ¢ Agence :</span>
              <span class="value">{{ selectedProgramme.agentGp.nomagence }}</span>
            </div>
            <div class="detail-item">
              <span class="label">ğŸ“ TÃ©lÃ©phone :</span>
              <span class="value">{{ selectedProgramme.agentGp.telephone }}</span>
            </div>
          </div>

          <div class="detail-item full-width">
            <span class="label">ğŸ“ Adresse Agence :</span>
            <span class="value">{{ selectedProgramme.agentGp.adresse }}</span>
          </div>

          <div class="detail-item full-width" *ngIf="selectedProgramme.description">
            <span class="label">ğŸ“ Description :</span>
            <span class="value">{{ selectedProgramme.description }}</span>
          </div>

          <div class="detail-item full-width" *ngIf="selectedProgramme.dateline">
            <span class="label">ğŸ“… Date limite :</span>
            <span class="value">{{ selectedProgramme.dateline | date:'dd/MM/yyyy' }}</span>
          </div>
        </div>
      </div>

      <!-- ===== INFORMATIONS CLIENT ===== -->
      <div class="form-section">
        <h3>ğŸ‘¤ Informations Client</h3>

        <!-- Disposition en deux colonnes pour les informations client -->
        <div class="form-row">
          <!-- Nom du client -->
          <div class="field">
            <label for="nomClient">Nom du Client *</label>
            <input
              id="nomClient"
              type="text"
              pInputText
              formControlName="nomClient"
              placeholder="Nom complet du client"
              [maxlength]="100"
              [disabled]="isFormDisabled"
              class="w-full"
            />
            <small class="text-info">
              {{ factureForm.get('nomClient')?.value?.length || 0 }}/100 caractÃ¨res
            </small>
            <small *ngIf="nomClientError" class="text-danger">
              <i class="pi pi-exclamation-triangle"></i>
              {{ nomClientError }}
            </small>
          </div>

          <!-- Adresse du client -->
          <div class="field">
            <label for="adresseClient">Adresse du Client *</label>
            <input
              id="adresseClient"
              type="text"
              pInputText
              formControlName="adresseClient"
              placeholder="Adresse complÃ¨te du client"
              [maxlength]="200"
              [disabled]="isFormDisabled"
              class="w-full"
            />
            <small class="text-info">
              {{ factureForm.get('adresseClient')?.value?.length || 0 }}/200 caractÃ¨res
            </small>
            <small *ngIf="adresseClientError" class="text-danger">
              <i class="pi pi-exclamation-triangle"></i>
              {{ adresseClientError }}
            </small>
          </div>
        </div>

        <div class="form-row">
          <!-- Valeur du bagage -->
          <div class="field">
            <label for="laveurBagage">Valeur du Bagage *</label>
            <input
              id="laveurBagage"
              type="text"
              pInputText
              formControlName="laveurBagage"
              placeholder="Valeur estimÃ©e du bagage"
              [maxlength]="100"
              [disabled]="isFormDisabled"
              class="w-full"
            />
            <small class="text-info">
              Description de la valeur du bagage transportÃ©
            </small>
            <small *ngIf="laveurBagageError" class="text-danger">
              <i class="pi pi-exclamation-triangle"></i>
              {{ laveurBagageError }}
            </small>
          </div>

          <!-- Nombre de KG -->
          <div class="field">
            <label for="nombreKg">Poids du Bagage (KG) *</label>
            <p-inputNumber
              id="nombreKg"
              formControlName="nombreKg"
              [showButtons]="true"
              buttonLayout="horizontal"
              spinnerMode="horizontal"
              decrementButtonClass="p-button-danger"
              incrementButtonClass="p-button-success"
              incrementButtonIcon="pi pi-plus"
              decrementButtonIcon="pi pi-minus"
              [min]="1"
              [max]="1000"
              [step]="1"
              placeholder="0"
              suffix=" KG"
              [disabled]="isFormDisabled"
              class="w-full"
            ></p-inputNumber>
            <small class="text-info">
              Poids total du bagage Ã  transporter
            </small>
            <small *ngIf="nombreKgError" class="text-danger">
              <i class="pi pi-exclamation-triangle"></i>
              {{ nombreKgError }}
            </small>
          </div>
        </div>

        <!-- Prix du transport calculÃ© automatiquement -->
        <div class="field">
          <label for="prixTransport">ğŸ’° Prix Total du Transport</label>
          <input
            id="prixTransport"
            type="text"
            pInputText
            formControlName="prixTransport"
            [readonly]="true"
            [style]="{'width': '100%', 'font-weight': 'bold', 'font-size': '1.1em', 'color': '#2196F3'}"
            class="text-center"
          />
          <small class="text-info">
            <i class="pi pi-info-circle"></i>
            Prix calculÃ© automatiquement :
            <span *ngIf="selectedProgramme">
              {{ selectedProgramme.prix }} Ã— {{ factureForm.get('nombreKg')?.value || 0 }} KG
            </span>
            <span *ngIf="!selectedProgramme">
              SÃ©lectionnez d'abord un programme
            </span>
          </small>
        </div>

        <!-- Notes optionnelles -->
        <div class="field">
          <label for="notes">ğŸ“ Notes / Commentaires (optionnel)</label>
          <textarea
            id="notes"
            pInputText
            formControlName="notes"
            rows="3"
            [maxlength]="500"
            placeholder="Informations supplÃ©mentaires, instructions spÃ©ciales..."
            [style]="{'width': '100%'}"
            [disabled]="isFormDisabled"
          ></textarea>
          <small class="text-info">
            {{ currentCharacterCount }}/500 caractÃ¨res
          </small>
          <small *ngIf="notesError" class="text-danger">
            <i class="pi pi-exclamation-triangle"></i>
            {{ notesError }}
          </small>
        </div>
      </div>

      <!-- ===== ZONE DE SIGNATURE ===== -->
      <div class="signature-section">
        <h3>âœï¸ Signature de l'Agence GP *</h3>
        <div class="signature-container" [class.error]="signatureError">
          <p class="signature-hint">
            <i class="pi pi-info-circle"></i>
            Signez dans la zone ci-dessous avec votre souris ou votre doigt (Ã©cran tactile)
          </p>

          <canvas
            #signatureCanvas
            width="450"
            height="200"
            [style]="{'border': '2px solid #ddd', 'border-radius': '8px', 'cursor': 'crosshair'}"
          ></canvas>

          <div class="signature-actions">
            <button
              type="button"
              pButton
              icon="pi pi-times"
              [rounded]="true"
              severity="danger"
              [outlined]="true"
              label="Effacer la signature"
              (click)="clearSignature()"
              [disabled]="isFormDisabled"
              [style]="{'margin-top': '10px'}"
            ></button>
          </div>

          <small *ngIf="!signatureData && selectedProgramme" class="signature-hint">
            âš ï¸ La signature est obligatoire pour crÃ©er la facture
          </small>

          <small *ngIf="signatureError" class="text-danger">
            <i class="pi pi-exclamation-triangle"></i>
            {{ signatureError }}
          </small>
        </div>
      </div>

      <!-- ===== RÃ‰CAPITULATIF AVANT CRÃ‰ATION ===== -->
      <div *ngIf="selectedProgramme && factureForm.get('nombreKg')?.value > 0" class="form-section">
        <h3>ğŸ“Š RÃ©capitulatif de la Facture</h3>
        <div class="info-grid">
          <div class="info-item">
            <span class="label">ğŸ›¤ï¸ Trajet :</span>
            <span class="value">{{ selectedProgramme.depart }} â†’ {{ selectedProgramme.destination }}</span>
          </div>
          <div class="info-item">
            <span class="label">ğŸ‘¤ Client :</span>
            <span class="value">{{ factureForm.get('nomClient')?.value || 'Non renseignÃ©' }}</span>
          </div>
          <div class="info-item">
            <span class="label">ğŸ“ Adresse :</span>
            <span class="value">{{ factureForm.get('adresseClient')?.value || 'Non renseignÃ©e' }}</span>
          </div>
          <div class="info-item">
            <span class="label">âš–ï¸ Poids :</span>
            <span class="value">{{ factureForm.get('nombreKg')?.value || 0 }} KG</span>
          </div>
          <div class="info-item">
            <span class="label">ğŸ’µ Prix unitaire :</span>
            <span class="value">{{ selectedProgramme.prix }}</span>
          </div>
          <div class="info-item">
            <span class="label font-bold">ğŸ’° Total Ã  payer :</span>
            <span class="value font-bold text-success">{{ getPrixTotalDisplay() }}</span>
          </div>
          <div class="info-item">
            <span class="label">ğŸ›¡ï¸ Garantie :</span>
            <span class="value">{{ selectedProgramme.garantie }}%</span>
          </div>
          <div class="info-item">
            <span class="label">ğŸ¢ Agence :</span>
            <span class="value">{{ selectedProgramme.agentGp.nomagence }}</span>
          </div>
        </div>
      </div>

      <!-- ===== BOUTONS D'ACTION ===== -->
      <div class="form-actions">
        <div class="action-buttons">
          <button
            type="submit"
            pButton
            icon="pi pi-check"
            [rounded]="true"
            [outlined]="false"
            severity="success"
            label="ğŸ§¾ CrÃ©er la Facture"
            [disabled]="!canCreateInvoice"
            [loading]="isLoading"
            [style]="{'font-size': '1.1em', 'padding': '12px 24px'}"
          ></button>

          <button
            type="button"
            pButton
            icon="pi pi-list"
            [rounded]="true"
            [outlined]="true"
            severity="info"
            label="ğŸ“‹ Mes Factures"
            (click)="goToFactureList()"
            [disabled]="isLoading"
            [style]="{'margin-left': '15px'}"
          ></button>

          <button
            type="button"
            pButton
            icon="pi pi-refresh"
            [rounded]="true"
            [outlined]="true"
            severity="secondary"
            label="ğŸ”„ RÃ©initialiser"
            (click)="createNewInvoice()"
            [disabled]="isLoading"
            [style]="{'margin-left': '15px'}"
          ></button>
        </div>

        <!-- Aide contextuelle -->
        <div class="help-section" *ngIf="!canCreateInvoice && !isLoading">
          <p class="text-color-secondary">
            <i class="pi pi-info-circle"></i>
            Pour crÃ©er une facture, vous devez :
          </p>
          <ul class="text-color-secondary">
            <li *ngIf="!selectedProgramme">SÃ©lectionner un programme</li>
            <li *ngIf="!factureForm.valid">Remplir tous les champs obligatoires</li>
            <li *ngIf="!signatureData">Apposer votre signature</li>
          </ul>
        </div>
      </div>
    </form>
  </div>

  <!-- ===== AFFICHAGE APRÃˆS CRÃ‰ATION DE LA FACTURE ===== -->
  <div *ngIf="factureGeneree && factureCreee" class="invoice-success">
    <div class="success-header">
      <i class="pi pi-check-circle"></i>
      <h3>âœ… Facture crÃ©Ã©e avec succÃ¨s !</h3>
      <p class="success-subtitle">
        Votre facture a Ã©tÃ© gÃ©nÃ©rÃ©e et est maintenant disponible
      </p>
    </div>

    <!-- Informations de la facture crÃ©Ã©e -->
    <div class="invoice-info">
      <h4>ğŸ“‹ Informations de la Facture</h4>
      <div class="info-grid">
        <div class="info-item">
          <span class="label">ğŸ“‹ NumÃ©ro :</span>
          <span class="value font-bold">{{ factureCreee.numeroFacture }}</span>
        </div>
        <div class="info-item">
          <span class="label">ğŸ‘¤ Client :</span>
          <span class="value">{{ factureCreee.nomClient }}</span>
        </div>
        <div class="info-item">
          <span class="label">ğŸ’° Montant :</span>
          <span class="value font-bold text-success">{{ formatPrixDisplay(factureCreee.prixTransport) }}</span>
        </div>
        <div class="info-item">
          <span class="label">ğŸ·ï¸ Statut :</span>
          <span class="value">
            <p-tag
              [severity]="getStatutColor()"
              [value]="getStatutLabel()"
              [icon]="getStatutIcon()">
            </p-tag>
          </span>
        </div>
        <div class="info-item">
          <span class="label">ğŸ“… Date de crÃ©ation :</span>
          <span class="value">{{ factureCreee.dateCreation | date:'dd/MM/yyyy Ã  HH:mm' }}</span>
        </div>
        <div class="info-item">
          <span class="label">ğŸ›¤ï¸ Trajet :</span>
          <span class="value">{{ factureCreee.depart }} â†’ {{ factureCreee.destination }}</span>
        </div>
        <div class="info-item">
          <span class="label">âš–ï¸ Poids :</span>
          <span class="value">{{ factureCreee.nombreKg }} KG</span>
        </div>
        <div class="info-item">
          <span class="label">ğŸ’µ Prix unitaire :</span>
          <span class="value">{{ formatPrixDisplay(factureCreee.prixUnitaire) }}</span>
        </div>
        <div class="info-item full-width" *ngIf="factureCreee.notes">
          <span class="label">ğŸ“ Notes :</span>
          <span class="value">{{ factureCreee.notes }}</span>
        </div>
      </div>
    </div>

    <!-- Actions sur la facture -->
    <div class="invoice-actions">
      <h3>ğŸ› ï¸ Actions disponibles</h3>

      <div class="action-buttons">
        <!-- Actions principales -->
        <div class="primary-actions">
          <button
            pButton
            icon="pi pi-eye"
            [rounded]="true"
            [outlined]="false"
            severity="info"
            label="ğŸ‘ï¸ PrÃ©visualiser PDF"
            (click)="previewPDF()"
            [disabled]="isLoading"
          ></button>

          <button
            pButton
            icon="pi pi-download"
            [rounded]="true"
            [outlined]="false"
            severity="success"
            label="ğŸ“¥ TÃ©lÃ©charger PDF"
            (click)="downloadPDF()"
            [disabled]="isLoading"
          ></button>

          <button
            pButton
            icon="pi pi-print"
            [rounded]="true"
            [outlined]="false"
            severity="primary"
            label="ğŸ–¨ï¸ Imprimer"
            (click)="printInvoice()"
            [disabled]="isLoading"
          ></button>
        </div>

        <!-- Actions de gestion du statut -->
        <div class="status-actions" *ngIf="isFactureNonPayee()">
          <button
            pButton
            icon="pi pi-check"
            [rounded]="true"
            [outlined]="false"
            severity="success"
            label="âœ… Marquer comme PayÃ©e"
            (click)="marquerPayee()"
            [disabled]="isLoading"
          ></button>
        </div>

        <!-- Bouton de partage -->
        <div class="share-actions">
          <button
            pButton
            icon="pi pi-share-alt"
            [rounded]="true"
            [outlined]="true"
            severity="help"
            label="ğŸ“¤ Partager"
            (click)="toggleShareOptions()"
            [disabled]="isLoading"
          ></button>
        </div>
      </div>

      <!-- Options de partage -->
      <div *ngIf="showShareOptions" class="share-options">
        <div class="share-title">ğŸ“± Partager la facture via :</div>
        <div class="share-buttons">
          <button
            pButton
            [rounded]="true"
            [outlined]="false"
            severity="success"
            icon="pi pi-whatsapp"
            label="ğŸ“± WhatsApp"
            (click)="shareViaWhatsApp()"
            [disabled]="isLoading"
          ></button>

          <button
            pButton
            [rounded]="true"
            [outlined]="false"
            severity="info"
            icon="pi pi-envelope"
            label="ğŸ“§ Email"
            (click)="shareViaEmail()"
            [disabled]="isLoading"
          ></button>
        </div>
      </div>

      <!-- Section de navigation -->
      <div class="navigation-section">
        <p-divider></p-divider>
        <h4>ğŸš€ Que souhaitez-vous faire maintenant ?</h4>

        <div class="navigation-buttons">
          <button
            pButton
            icon="pi pi-plus"
            [rounded]="true"
            [outlined]="true"
            severity="secondary"
            label="â• CrÃ©er une nouvelle facture"
            (click)="createNewInvoice()"
            [disabled]="isLoading"
          ></button>

          <button
            pButton
            icon="pi pi-list"
            [rounded]="true"
            [outlined]="true"
            severity="info"
            label="ğŸ“‹ Voir toutes mes factures"
            (click)="goToFactureList()"
            [disabled]="isLoading"
          ></button>
        </div>
      </div>
    </div>
  </div>

  <!-- Section d'aide -->
  <div class="help-footer" *ngIf="!factureGeneree">
    <p-divider></p-divider>
    <div class="help-content">
      <h4>ğŸ’¡ Besoin d'aide ?</h4>
      <ul>
        <li>Assurez-vous d'avoir crÃ©Ã© au moins un programme GP avant de crÃ©er une facture</li>
        <li>Tous les champs marquÃ©s d'un * sont obligatoires</li>
        <li>La signature Ã©lectronique est requise pour valider la facture</li>
        <li>Le prix est calculÃ© automatiquement selon le programme sÃ©lectionnÃ©</li>
        <li>Vous pouvez ajouter des notes pour des informations complÃ©mentaires</li>
      </ul>
    </div>
  </div>
</div>
