<app-menu></app-menu>

<!-- Toast notifications -->
<p-toast position="top-right"></p-toast>

<!-- Confirmation dialog -->
<p-confirmDialog></p-confirmDialog>

<div class="facture-list-container">
  <!-- Header avec statistiques -->
  <div class="header-section">
    <div class="page-header">
      <div class="header-content">
        <h1 class="page-title">
          <i class="pi pi-file-text"></i>
          Mes Factures
        </h1>
        <p class="page-subtitle">Gérez et suivez toutes vos factures</p>
      </div>

      <div class="header-actions">
        <p-button
          icon="pi pi-refresh"
          [outlined]="true"
          [rounded]="true"
          severity="info"
          (onClick)="refreshData()"
          pTooltip="Actualiser les données"
          tooltipPosition="bottom">
        </p-button>

        <p-button
          icon="pi pi-plus"
          label="Nouvelle Facture"
          [rounded]="true"
          severity="success"
          (onClick)="creerNouvelleFacture()">
        </p-button>
      </div>
    </div>

    <!-- Statistiques -->
    <div class="statistics-section" *ngIf="statistiques">
      <div class="stats-grid">
        <div class="stat-card total">
          <div class="stat-icon">
            <i class="pi pi-file-text"></i>
          </div>
          <div class="stat-content">
            <div class="stat-value">{{ statistiques.nombreFactures }}</div>
            <div class="stat-label">Total Factures</div>
          </div>
        </div>

        <div class="stat-card paid">
          <div class="stat-icon">
            <i class="pi pi-check-circle"></i>
          </div>
          <div class="stat-content">
            <div class="stat-value">{{ statistiques.nombreFacturesPayees }}</div>
            <div class="stat-label">Payées</div>
            <div class="stat-percentage">{{ statistiques.pourcentagePayees }}%</div>
          </div>
        </div>

        <div class="stat-card unpaid">
          <div class="stat-icon">
            <i class="pi pi-clock"></i>
          </div>
          <div class="stat-content">
            <div class="stat-value">{{ statistiques.nombreFactures - statistiques.nombreFacturesPayees }}</div>
            <div class="stat-label">En attente</div>
            <div class="stat-percentage">{{ 100 - statistiques.pourcentagePayees }}%</div>
          </div>
        </div>

        <div class="stat-card revenue">
          <div class="stat-icon">
            <i class="pi pi-euro"></i>
          </div>
          <div class="stat-content">
            <div class="stat-value">{{ formatCurrency(statistiques.totalFactures) }}</div>
            <div class="stat-label">Chiffre d'affaires</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Barre d'outils et filtres -->
  <div class="content-section">
    <p-card>
      <!-- Toolbar -->
      <p-toolbar>
        <div class="p-toolbar-group-start">
          <!-- Recherche globale -->
          <span class="p-input-icon-left">
            <i class="pi pi-search"></i>
            <input
              pInputText
              type="text"
              placeholder="Recherche globale..."
              [(ngModel)]="globalFilterValue"
              (input)="applyGlobalFilter($event)"
              class="global-search">
          </span>

          <!-- Bouton filtres avancés -->
          <p-button
          icon="pi pi-filter"
          [outlined]="true"
          [rounded]="true"
          severity="secondary"
          (onClick)="toggleAdvancedFilters()"
          [badge]="hasActiveFilters ? '●' : undefined"
          badgeClass="filter-badge"
          pTooltip="Filtres avancés"
          tooltipPosition="bottom">
          </p-button>

          <!-- Clear filters -->
          <p-button
            icon="pi pi-filter-slash"
            [outlined]="true"
            [rounded]="true"
            severity="danger"
            (onClick)="clearFilters()"
            [disabled]="!hasActiveFilters"
            pTooltip="Effacer les filtres"
            tooltipPosition="bottom">
          </p-button>
        </div>

        <div class="p-toolbar-group-center">
          <!-- Sélection groupée -->
          <div class="bulk-actions" *ngIf="selectedFactures.length > 0">
            <p-chip [label]="selectedFactures.length + ' sélectionnée(s)'"></p-chip>
            <p-splitButton
              icon="pi pi-cog"
              label="Actions"
              [model]="bulkActions"
              severity="info"
              [rounded]="true">
            </p-splitButton>
          </div>
        </div>

        <div class="p-toolbar-group-end">
          <!-- Export -->
          <p-splitButton
            icon="pi pi-download"
            label="Export"
            [model]="exportActions"
            severity="help"
            [rounded]="true">
          </p-splitButton>
        </div>
      </p-toolbar>

      <!-- Filtres avancés -->
      <div class="advanced-filters" *ngIf="showAdvancedFilters">
        <div class="filters-grid">
          <div class="filter-group">
            <label for="nomClient">Nom du client</label>
            <input
              id="nomClient"
              pInputText
              [(ngModel)]="searchTerms.nomClient"
              (ngModelChange)="onAdvancedSearchChange()"
              placeholder="Rechercher par nom..."
              class="filter-input">
          </div>

          <div class="filter-group">
            <label for="numeroFacture">N° Facture</label>
            <input
              id="numeroFacture"
              pInputText
              [(ngModel)]="searchTerms.numeroFacture"
              (ngModelChange)="onAdvancedSearchChange()"
              placeholder="Ex: FAC-2024-001"
              class="filter-input">
          </div>

          <div class="filter-group">
            <label for="statut">Statut</label>
            <p-dropdown
              id="statut"
              [(ngModel)]="searchTerms.statut"
              [options]="statutOptions"
              optionLabel="label"
              optionValue="value"
              (ngModelChange)="onAdvancedSearchChange()"
              placeholder="Tous les statuts"
              [showClear]="true"
              class="filter-dropdown">
            </p-dropdown>
          </div>

          <div class="filter-group">
            <label for="dateDebut">Date début</label>
            <p-calendar
              id="dateDebut"
              [(ngModel)]="searchTerms.dateDebut"
              (onSelect)="onAdvancedSearchChange()"
              (onClearClick)="onAdvancedSearchChange()"
              dateFormat="dd/mm/yy"
              placeholder="Date début"
              [showIcon]="true"
              [showButtonBar]="true"
              class="filter-calendar">
            </p-calendar>
          </div>

          <div class="filter-group">
            <label for="dateFin">Date fin</label>
            <p-calendar
              id="dateFin"
              [(ngModel)]="searchTerms.dateFin"
              (onSelect)="onAdvancedSearchChange()"
              (onClearClick)="onAdvancedSearchChange()"
              dateFormat="dd/mm/yy"
              placeholder="Date fin"
              [showIcon]="true"
              [showButtonBar]="true"
              class="filter-calendar">
            </p-calendar>
          </div>
        </div>

        <!-- Actions pour les filtres -->
        <div style="display: flex; justify-content: end; gap: 10px; margin-top: 15px;">
          <p-button
            label="Réinitialiser"
            icon="pi pi-refresh"
            severity="secondary"
            [outlined]="true"
            (onClick)="clearFilters()">
          </p-button>
          <p-button
            label="Appliquer"
            icon="pi pi-check"
            severity="primary"
            (onClick)="onAdvancedSearchChange()">
          </p-button>
        </div>
      </div>

      <!-- Loading Skeleton -->
      <div class="skeleton-container" *ngIf="loading">
        <div class="skeleton-cards-grid">
          <div class="skeleton-card" *ngFor="let item of [1,2,3,4,5,6,7,8]">
            <p-skeleton width="100%" height="200px" borderRadius="8px"></p-skeleton>
          </div>
        </div>
      </div>

      <!-- Vue Cartes -->
      <div class="cards-container" *ngIf="!loading">
        <div class="cards-grid">
          <div class="facture-card" *ngFor="let facture of factures" [class.selected]="selectedFactures.includes(facture)">
            <!-- Header de la carte -->
            <div class="card-header">
              <div class="card-title">
                <p-checkbox
                  [(ngModel)]="selectedFactures"
                  [value]="facture"
                  [binary]="false">
                </p-checkbox>
                <span class="facture-number">{{ facture.numeroFacture }}</span>
                <p-tag
                  [severity]="getStatutSeverity(facture.statut)"
                  [value]="getStatutLabel(facture.statut)"
                  [icon]="getStatutIcon(facture.statut)">
                </p-tag>
              </div>
              <div class="card-actions">
                <p-button
                  icon="pi pi-ellipsis-v"
                  [text]="true"
                  [rounded]="true"
                  severity="secondary"
                  (onClick)="openFactureMenu($event, facture, cardMenu)"
                  size="small">
                </p-button>
                <p-menu #cardMenu [model]="factureActions" [popup]="true"></p-menu>
              </div>
            </div>

            <!-- Contenu de la carte -->
            <div class="card-content">
              <div class="client-section">
                <h4>{{ facture.nomClient }}</h4>
                <p class="client-address">{{ facture.adresseClient }}</p>
              </div>

              <div class="journey-section">
                <div class="journey">
                  <span class="departure">{{ facture.depart }}</span>
                  <i class="pi pi-arrow-right"></i>
                  <span class="destination">{{ facture.destination }}</span>
                </div>
                <div class="weight">{{ facture.nombreKg }} KG</div>
              </div>

              <div class="amount-section">
                <div class="amount">{{ formatCurrency(facture.prixTransport) }}</div>
                <div class="unit-price">{{ formatCurrency(facture.prixUnitaire) }}/KG</div>
              </div>

              <div class="date-section">
                <small>{{ formatDate(facture.dateCreation) }}</small>
              </div>
            </div>

            <!-- Actions de la carte -->
            <div class="card-footer">
              <p-button
                *ngIf="facture.statut === 'NON_PAYEE'"
                icon="pi pi-check"
                label="Marquer payée"
                severity="success"
                size="small"
                [outlined]="true"
                (onClick)="marquerPayee(facture)">
              </p-button>

              <p-button
                *ngIf="facture.statut === 'PAYEE'"
                icon="pi pi-undo"
                label="Marquer non payée"
                severity="warning"
                size="small"
                [outlined]="true"
                (onClick)="marquerNonPayee(facture)">
              </p-button>

              <p-button
                icon="pi pi-eye"
                label="Détails"
                severity="info"
                size="small"
                [outlined]="true"
                (onClick)="voirDetails(facture)">
              </p-button>

              <p-button
                icon="pi pi-download"
                severity="help"
                size="small"
                [text]="true"
                [rounded]="true"
                pTooltip="Télécharger PDF"
                (onClick)="telechargerPDF(facture)">
              </p-button>
            </div>
          </div>
        </div>

        <!-- État vide -->
        <div class="empty-state" *ngIf="factures.length === 0 && !loading">
          <i class="pi pi-info-circle"></i>
          <h3>Aucune facture trouvée</h3>
          <p>{{ hasActiveFilters ? 'Aucune facture ne correspond à vos critères de recherche.' : 'Vous n\'avez pas encore créé de factures.' }}</p>
          <p-button
            *ngIf="!hasActiveFilters"
            label="Créer ma première facture"
            icon="pi pi-plus"
            (onClick)="creerNouvelleFacture()">
          </p-button>
        </div>

        <!-- Pagination pour les cartes -->
        <div class="pagination-container" *ngIf="factures.length > 0">
          <p-paginator
            [rows]="rows"
            [totalRecords]="totalRecords"
            [first]="first"
            [rowsPerPageOptions]="rowsPerPageOptions"
            [showCurrentPageReport]="true"
            currentPageReportTemplate="Affichage de {first} à {last} sur {totalRecords} factures"
            (onPageChange)="onPageChange($event)">
          </p-paginator>
        </div>
      </div>
    </p-card>
  </div>
</div>