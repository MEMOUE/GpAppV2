<!-- GpFront/src/app/profile/profile.component.html -->
<div class="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 py-12 px-4 sm:px-6 lg:px-8">
  <p-toast></p-toast>

  <div class="max-w-4xl mx-auto">
    <!-- En-tête -->
    <div class="bg-white rounded-xl shadow-2xl p-8 mb-6">
      <div class="flex items-center justify-between mb-6">
        <div class="flex items-center space-x-4">
          <div class="w-20 h-20 bg-gradient-to-br from-blue-500 to-blue-600 rounded-full flex items-center justify-center text-white font-bold text-2xl shadow-lg">
            {{ getInitials() }}
          </div>
          <div>
            <h1 class="text-3xl font-bold text-gray-800">{{ userProfile?.username }}</h1>
            <p class="text-gray-600">{{ userProfile?.email }}</p>
            <div class="flex gap-2 mt-2">
              <p-chip
                *ngFor="let role of userProfile?.roles"
                [label]="getRoleLabel(role)"
                styleClass="bg-blue-100 text-blue-800"
              ></p-chip>
            </div>
          </div>
        </div>

        <button
          *ngIf="!editMode"
          (click)="toggleEditMode()"
          class="flex items-center gap-2 px-4 py-2 text-sm font-semibold text-white bg-blue-600 rounded-lg hover:bg-blue-700 transition-all"
        >
          <i class="pi pi-pencil"></i>
          <span>Modifier</span>
        </button>
      </div>

      <p-divider></p-divider>

      <!-- Formulaire de profil -->
      <form [formGroup]="profileForm" (ngSubmit)="onSubmitProfile()" class="space-y-6">
        <!-- Nom d'utilisateur (lecture seule) -->
        <div>
          <label for="username" class="block text-sm font-semibold text-gray-700 mb-2">
            Nom d'utilisateur
          </label>
          <input
            pInputText
            id="username"
            formControlName="username"
            class="w-full px-4 py-3 border border-gray-300 rounded-lg bg-gray-50"
          />
          <small class="block mt-1 text-sm text-gray-500">
            Le nom d'utilisateur ne peut pas être modifié
          </small>
        </div>

        <!-- Email -->
        <div>
          <label for="email" class="block text-sm font-semibold text-gray-700 mb-2">
            Email
          </label>
          <input
            pInputText
            id="email"
            type="email"
            formControlName="email"
            [disabled]="!editMode"
            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200"
            [ngClass]="{
              'border-red-500 focus:ring-red-500': profileForm.get('email')?.invalid && profileForm.get('email')?.touched,
              'bg-gray-50': !editMode
            }"
          />
          <small
            *ngIf="profileForm.get('email')?.invalid && profileForm.get('email')?.touched"
            class="block mt-1 text-sm text-red-600"
          >
            {{ getErrorMessage('email') }}
          </small>
        </div>

        <!-- Champs Agent GP -->
        <div *ngIf="isAgentGP" class="bg-blue-50 border-l-4 border-blue-500 rounded-r-lg p-6 space-y-6">
          <h3 class="text-lg font-bold text-gray-800 mb-4">Informations de l'agence</h3>

          <!-- Nom de l'agence -->
          <div>
            <label for="nomagence" class="block text-sm font-semibold text-gray-700 mb-2">
              Nom de l'agence
            </label>
            <input
              pInputText
              id="nomagence"
              formControlName="nomagence"
              [disabled]="!editMode"
              class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200"
              [ngClass]="{ 'bg-gray-50': !editMode }"
            />
          </div>

          <!-- Adresse -->
          <div>
            <label for="adresse" class="block text-sm font-semibold text-gray-700 mb-2">
              Adresse
            </label>
            <input
              pInputText
              id="adresse"
              formControlName="adresse"
              [disabled]="!editMode"
              class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200"
              [ngClass]="{ 'bg-gray-50': !editMode }"
            />
          </div>

          <!-- Téléphone -->
          <div>
            <label for="telephone" class="block text-sm font-semibold text-gray-700 mb-2">
              Téléphone
            </label>
            <input
              pInputText
              id="telephone"
              formControlName="telephone"
              [disabled]="!editMode"
              class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200"
              [ngClass]="{ 'bg-gray-50': !editMode }"
            />
          </div>

          <!-- Destinations -->
          <div>
            <label for="destinations" class="block text-sm font-semibold text-gray-700 mb-2">
              Destinations
            </label>
            <input
              pInputText
              id="destinations"
              formControlName="destinations"
              [disabled]="!editMode"
              placeholder="Paris, Lyon, Marseille"
              class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200"
              [ngClass]="{ 'bg-gray-50': !editMode }"
            />
            <small class="block mt-1 text-sm text-gray-500">
              Séparez les destinations par des virgules
            </small>
          </div>

          <!-- Logo -->
          <div *ngIf="editMode">
            <label for="logo" class="block text-sm font-semibold text-gray-700 mb-2">
              Logo de l'agence
            </label>

            <!-- Prévisualisation -->
            <div *ngIf="previewUrls['logo']" class="mb-3">
              <img [src]="previewUrls['logo']" alt="Logo" class="h-32 w-auto rounded-lg border-2 border-gray-200">
            </div>

            <input
              type="file"
              id="logo"
              accept="image/*"
              (change)="onFileSelected('logo', $event)"
              class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100 cursor-pointer border border-gray-300 rounded-lg transition duration-200"
            />
            <small
              *ngIf="fileErrors['logo']"
              class="block mt-1 text-sm text-red-600"
            >
              {{ fileErrors['logo'] }}
            </small>
          </div>

          <!-- Carte d'identité -->
          <div *ngIf="editMode">
            <label for="carteIdentite" class="block text-sm font-semibold text-gray-700 mb-2">
              Carte d'identité
            </label>

            <!-- Prévisualisation -->
            <div *ngIf="previewUrls['carteIdentite']" class="mb-3">
              <img [src]="previewUrls['carteIdentite']" alt="Carte d'identité" class="h-32 w-auto rounded-lg border-2 border-gray-200">
            </div>

            <input
              type="file"
              id="carteIdentite"
              accept="image/*"
              (change)="onFileSelected('carteIdentite', $event)"
              class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100 cursor-pointer border border-gray-300 rounded-lg transition duration-200"
            />
            <small
              *ngIf="fileErrors['carteIdentite']"
              class="block mt-1 text-sm text-red-600"
            >
              {{ fileErrors['carteIdentite'] }}
            </small>
          </div>
        </div>

        <!-- Boutons d'action -->
        <div *ngIf="editMode" class="flex gap-3 pt-4">
          <p-button
            label="Enregistrer"
            icon="pi pi-check"
            type="submit"
            [disabled]="!profileForm.valid || loading"
            styleClass="flex-1 py-3 bg-blue-600 hover:bg-blue-700"
          ></p-button>

          <p-button
            label="Annuler"
            icon="pi pi-times"
            type="button"
            (onClick)="toggleEditMode()"
            styleClass="flex-1 py-3 bg-gray-600 hover:bg-gray-700"
          ></p-button>
        </div>
      </form>
    </div>

    <!-- Section Mot de passe -->
    <div class="bg-white rounded-xl shadow-2xl p-8">
      <div class="flex items-center justify-between mb-6">
        <h2 class="text-2xl font-bold text-gray-800">Sécurité</h2>
        <button
          *ngIf="!changePasswordMode"
          (click)="togglePasswordMode()"
          class="flex items-center gap-2 px-4 py-2 text-sm font-semibold text-white bg-indigo-600 rounded-lg hover:bg-indigo-700 transition-all"
        >
          <i class="pi pi-lock"></i>
          <span>Changer le mot de passe</span>
        </button>
      </div>

      <form *ngIf="changePasswordMode" [formGroup]="passwordForm" (ngSubmit)="onSubmitPassword()" class="space-y-6">
        <!-- Mot de passe actuel -->
        <div>
          <label for="currentPassword" class="block text-sm font-semibold text-gray-700 mb-2">
            Mot de passe actuel
          </label>
          <input
            pInputText
            id="currentPassword"
            type="password"
            formControlName="currentPassword"
            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition duration-200"
            [ngClass]="{
              'border-red-500 focus:ring-red-500': passwordForm.get('currentPassword')?.invalid && passwordForm.get('currentPassword')?.touched
            }"
          />
          <small
            *ngIf="passwordForm.get('currentPassword')?.invalid && passwordForm.get('currentPassword')?.touched"
            class="block mt-1 text-sm text-red-600"
          >
            {{ getErrorMessage('currentPassword', passwordForm) }}
          </small>
        </div>

        <!-- Nouveau mot de passe -->
        <div>
          <label for="newPassword" class="block text-sm font-semibold text-gray-700 mb-2">
            Nouveau mot de passe
          </label>
          <input
            pInputText
            id="newPassword"
            type="password"
            formControlName="newPassword"
            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition duration-200"
            [ngClass]="{
              'border-red-500 focus:ring-red-500': passwordForm.get('newPassword')?.invalid && passwordForm.get('newPassword')?.touched
            }"
          />
          <small
            *ngIf="passwordForm.get('newPassword')?.invalid && passwordForm.get('newPassword')?.touched"
            class="block mt-1 text-sm text-red-600"
          >
            {{ getErrorMessage('newPassword', passwordForm) }}
          </small>
        </div>

        <!-- Confirmer le mot de passe -->
        <div>
          <label for="confirmPassword" class="block text-sm font-semibold text-gray-700 mb-2">
            Confirmer le nouveau mot de passe
          </label>
          <input
            pInputText
            id="confirmPassword"
            type="password"
            formControlName="confirmPassword"
            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition duration-200"
            [ngClass]="{
              'border-red-500 focus:ring-red-500': passwordForm.get('confirmPassword')?.invalid && passwordForm.get('confirmPassword')?.touched
            }"
          />
          <small
            *ngIf="passwordForm.get('confirmPassword')?.invalid && passwordForm.get('confirmPassword')?.touched"
            class="block mt-1 text-sm text-red-600"
          >
            {{ getErrorMessage('confirmPassword', passwordForm) }}
          </small>
        </div>

        <!-- Boutons d'action -->
        <div class="flex gap-3 pt-4">
          <p-button
            label="Changer le mot de passe"
            icon="pi pi-check"
            type="submit"
            [disabled]="!passwordForm.valid || loading"
            styleClass="flex-1 py-3 bg-indigo-600 hover:bg-indigo-700"
          ></p-button>

          <p-button
            label="Annuler"
            icon="pi pi-times"
            type="button"
            (onClick)="togglePasswordMode()"
            styleClass="flex-1 py-3 bg-gray-600 hover:bg-gray-700"
          ></p-button>
        </div>
      </form>
    </div>
  </div>
</div>
